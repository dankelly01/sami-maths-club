name: Build IOS
on:
  push:
    branches:
      - ios
jobs:
  ios:
    name: Build IOS
    runs-on: macOS-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@master
      # - name: Setup Cache
      #   uses: actions/cache@v2
      #   with:
      #     path: "**/node_modules"
      #     key: ${{ runner.os }}-modules-${{ hashFiles('**/yarn.lock') }}
      # - name: Install Dependencies
      #   run: yarn install
      # - name: Build App
      #   run: npm run app:build
      - name: Setup environment
        # TODO - look at other signing options, e.g.
        run: |
          cd maths-club-app/ios/App
          echo $MOBILEPROVISION_BASE64 | base64 --decode > ios-build.mobileprovision
        env:
          MOBILEPROVISION_BASE64: ${{secrets.IOS_PROVISION_BASE64}}
      - name: Install fastlane
        run: |
          cd maths-club-app/ios/App
          sudo gem install fastlane -NV
      - name: Run fastlane
        run: |
          cd maths-club-app/ios/App
          fastlane ios ci_beta --verbose
        env:
          # created when first initialising match certs
          MATCH_PASSWORD: ${{secrets.FASTFILE_MATCH_PASSWORD}}
          # apple dev account pw, used to generate/refresh/verify certs (not required if readonly mode?)
          FASTLANE_PASSWORD: ${{secrets.IOS_DEVACCOUNT_PW}}
          # basic auth creds: "git_username:git_personal_access_token_for_match_repo"
          FASTLANE_MATCH_GITHUB_AUTH: ${{secrets.FASTLANE_MATCH_GITHUB_AUTH}}
          # Generated from appleid.apple.com/account/manage (login to avoid 2fa)
          FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{secrets.FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD}}
